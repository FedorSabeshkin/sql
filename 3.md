# Рефлексия по третьему заданию
Запрос надо дополнить тем, что бы:  
1. Результат по простым полям оборачивать в JSON.
2. Если планируем доставать запись не по id, а сразу несколько - то обернуть это в JSON_AGG, что бы получать для REST API массив json объектов.
3. JSON_BUILD_OBJECT подойдет, т.к. смогу сохранить id числовым типом.

```sql

SELECT JSON_AGG(
	JSON_BUILD_OBJECT(
		'fortress_id', f.fortress_id,
		'name', f.name,
		'location', f.location,
		'founded_year', f.founded_year,
		'related_entities', JSON_OBJECT(
				'dwarf_ids', (
					SELECT JSON_ARRAYAGG(d.dwarf_id)
					FROM dwarves d
					WHERE d.fortress_id = f.fortress_id
				),
				'resource_ids', (
					SELECT JSON_ARRAYAGG(fr.resource_id)
					FROM fortress_resources fr
					WHERE fr.fortress_id = f.fortress_id
				),
				'workshop_ids', (
					SELECT JSON_ARRAYAGG(w.workshop_id)
					FROM workshops w
					WHERE w.fortress_id = f.fortress_id
				),
				'squad_ids', (
					SELECT JSON_ARRAYAGG(s.squad_id)
					FROM military_squads s
					WHERE s.fortress_id = f.fortress_id
				)
			) AS related_entities
		) AS json_castle
	)
FROM 
    fortresses f;

```