# Пятое задание
SELECT JSON_AGG(
	JSON_BUILD_OBJECT(
    	e.expedition_id, 
		e.destination, 
		e.status,
		survival_rate_table.survival_rate s_r,
		artifacts_value_table.artifacts_value a_v,
		discovered_sites_table.discovered_sites dis_s,
		encounter_success_rate_table.encounter_success_rate e_s_rate,
		'related_entities', JSON_BUILD_OBJECT(
								'member_ids', (
									SELECT JSON_ARRAYAGG(dw_sk.dwarf_id)
									FROM expedition_member e_m_inner
									WHERE e_m_inner.expedition_id = e.expedition_id 
								),
								'artifact_ids', (
									SELECT JSON_ARRAYAGG(dw_sk.artifact_id)
									FROM expedition_artifacts e_a_inner
									WHERE e_a_inner.expedition_id = e.expedition_id 
								),
								'site_ids', (
									SELECT JSON_ARRAYAGG(dw_sk.artifact_id)
									FROM expedition_sites e_s_inner
									WHERE e_s_inner.expedition_id = e.expedition_id 
								)
							)	
	)
FROM expeditions e
JOIN (SELECT e.expedition_id,
		(SELECT e_m.expedition_id, COUNT(*) AS DECIMAL(10, 2)
			FROM EXPEDITION_MEMBERS e_m
			WHERE survived = TRUE
			GROUP BY e_m.expedition_id) / 
		(SELECT e_m_all.expedition_id, COUNT(*)
			FROM EXPEDITION_MEMBERS e_m_all
			GROUP BY e_m_all.expedition_id) survival_rate
	) survival_rate_table
	ON survival_rate_table.expedition_id = e.expedition_id
JOIN (SELECT e_a.expedition_id, SUM(ea.value) artifacts_value
		FROM EXPEDITION_ARTIFACTS e_a  
		GROUP BY e_a.expedition_id) artifacts_value_table
	ON artifacts_value_table.expedition_id = e.expedition_id
JOIN (SELECT e_s.expedition_id, COUNT(*) discovered_sites
		FROM EXPEDITION_SITES e_s
		WHERE e_s.discovery_date > e.departure_date
		GROUP BY e_s.expedition_id) discovered_sites_table
	ON discovered_sites_table.expedition_id = e.expedition_id
JOIN (SELECT e_c.expedition_id, 
		(SELECT  e_c_suc.expedition_id, COUNT(*) AS DECIMAL(10, 2)
			FROM EXPEDITION_CREATURES e_c_suc
			WHERE outcome = SUCCESS
			GROUP BY e_c_suc.expedition_id) / 
		(SELECT e_c_fail.expedition_id, COUNT(*)
			FROM EXPEDITION_CREATURES e_c
			WHERE outcome = FAIL
			GROUP BY e_c_fail.expedition_id)
		FROM EXPEDITION_CREATURES e_c) encounter_success_rate
	ON encounter_success_rate.expedition_id = e.expedition_id
JOIN (SELECT 	
		skill_improvement_each_dwarf_table.expedition_id
		SUM(skill_improvement_each_dwarf_table.diff_skills)
			(SELECT e_second.expedition_id, 
					e_second_m.dwarf_id, 
					e_second.departure_date,
					(COUNT(d_s_before.skill_id) - COUNT(d_s_after.skill_id)) diff_skills
			FROM expeditions e_second
			JOIN expedition_members e_m ON e_m.expedition_id = e_second.expedition_id 
			LEFT JOIN dwarf_skills d_s_before ON d_s_before.dwarf_id = e_second_m.dwarf_id 
				AND d_s_before.date < e_second.departure_date
			LEFT JOIN dwarf_skills d_s_after ON d_s_after.dwarf_id = e_m.dwarf_id 
				AND d_s_after.date >= e_second.departure_date
			GROUP BY e_second.expedition_id, 
					 e_second_m.dwarf_id, 
					 e_second.departure_date) skill_improvement_each_dwarf_table
	   GROUP BY skill_improvement_each_dwarf_table.expedition_id) skill_improvement_table
	ON skill_improvement_table.expedition_id = e.expedition_id
ORDER BY s_r DESC,
		a_v DESC,
		dis_s DESC,
		e_s_rate DESC
