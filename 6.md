6.Мастерские (Workshops): Принадлежат крепости (n:1), включают ремесленников (n:m), материалы (n:m), производят продукты (1:n)

7.Ремесленники мастерских (Workshop_Craftsdwarves): Связывает мастерские и гномов (n:m)

8.Материалы мастерских (Workshop_Materials): Связывает мастерские с используемыми материалами (n:m)

9.Продукты мастерских (Workshop_Products): Связывает мастерские с производимыми продуктами (n:m)

10.Продукты (Products): Результаты производства, связаны с материалами (n:1), мастерскими (n:1)

- Производительность каждого ремесленника (соотношение созданных продуктов к затраченному времени)
Нет прямой связи 1:1 между товаром и ремеслеником. 
Есть только связь между товаром и мастерской, и датой производства товара.
И гномом, датой прикрепления гнома к фабрике и фабрикой.
Можно проанализировать как увеличивалось производство товаров после прикрепления гномов.

Предположу, что по ожидаемым результатам имеется в виду производительность каждой мастерской.

- соотношение потребляемых ресурсов к производимым товарам
Достать in_
присоеденить products_manifacture
По fabric_id


- Качество производимых товаров (средневзвешенное по ценности)
сумма по всем ценностям товаров в группе
Отдельно self JOIN, что бы посчитать число продуктов в группе

- Время простоя мастерской  
Так же в БД нет такого понятия напрямую. 
Можно посмотреть, в какие дни created_date у продуктов не выпадает, что бы понять так промежутки в квартале. 
Да, могу посчитать время простоя в конкретной квартале.


- Влияние навыков ремесленников на качество товаров
Пока не понятно что под этим имеется в виду.
Вероятно сумма навыков всех занятых на производстве гномов (всех занятых в определенный период, например, квартал)
/
На сумму всех очков качества товаров у которы created_date попадает в заданный квартал

Посчитать мы можем весь этот запрос только к конкретному кварталу.

Делаю допущение для вычислений, что рассматриваю за 2026 год с 365 днями.


=Достану простые поля
-- число работников на фабрике
WITH (SELECT w.workshop_id,
		COUNT(w_c.dwarf_id) num_craftsdwarves
		FROM workshops w
		JOIN workshop_craftsdwarves w_c
			ON w_c.workshop_id = w.workshop_id
		GROUP BY w.workshop_id) 
						AS  num_craftsdwarves_table
,
	(SELECT w_p.workshop_id,
			SUM(w_p.quantity) total_quantity_produced
		FROM workshop_products w_p
		GROUP BY w_p.workshop_id) 
						AS total_quantity_produced_table
,
	(SELECT pr.workshop_id
			SUM(pr.value)  total_production_value,
		FROM products pr
		GROUP BY pr.workshop_id)
						AS total_production_value_table
,
	(SELECT w_m.workshop_id
			SUM(w_m.quantity)  total_workshop_materials,
		FROM workshop_materials w_m
		GROUP BY w_m.workshop_id)
						AS total_workshop_materials_table
,
	(SELECT d_s.dwarf_id, 
			CONT(d_s.skill_id) total_skills_per_dwarf,
		FROM DWARF_SKILLS d_s
		GROUP BY w_с.dwarf_id)
						AS total_skills_per_dwarf_table,
	(SELECT w_c.workshop_id,
			SUM(s_p_d.total_skills_per_dwarf) total_skills_per_workshop
		FROM workshop_craftsdwarves w_c
		JOIN total_skills_per_dwarf_table s_p_d
			ON s_p_d.dwarf_id = w_c.dwarf_id
		GROUP BY w_с.workshop_id) total_skills_per_workshop_table,
		
-- кол-во произведенных товаров фабриками в конкретный день. В запросе можно использовать через JOIN, если передавать дату
	(SELECT w_p.workshop_id,
			w_p.production_date,
			SUM(w_p.quantity) q_p_w_per_day
		FROM workshop_products w_p
		GROUP BY w_p.workshop_id,
				 w_p.production_date)
						AS q_p_w_per_day_t		
						
--
	(SELECT workshop_id,
			COUNT(*) amount
		FROM q_p_w_per_day_t
		WHERE q_p_w_per_day=0
		GROUP BY workshop_id,
	) AS zero_product_day_per_w

SELECT w.workshop_id,
		w.name workshop_name,
		w.type workshop_type,
		num_craftsdwarves_table.num_craftsdwarves,
		total_quantity_produced_table.total_quantity_produced,
		total_production_value_table.total_production_value,
		
		ROUND(total_quantity_produced_table.total_quantity_produced::DECIMAL / 
				365
		, 2) AS daily_production_rate,
		
		total_workshop_materials_table.total_workshop_materials,
		
		ROUND(total_quantity_produced_table.total_quantity_produced::DECIMAL / 
				NULLIF(total_workshop_materials_table.total_workshop_materials, 0)
		, 2) AS value_per_material_unit,
		
		
		
		ROUND(s_p_w.total_skills_per_workshop::DECIMAL / 
				NULLIF(num_craftsdwarves_table.num_craftsdwarves, 0)
		, 2) AS average_craftsdwarf_skill,
		
		ROUND(w.quality::DECIMAL / 
				NULLIF(s_p_w.total_skills_per_workshop, 0)
		, 2) AS skill_quality_correlation,
		
				
		COALESCE(ROUND((365 - zero_product_day_per_w.amount)::DECIMAL / 
				365
		, 2) * 100, 0) AS workshop_utilization_percent,
		
		JSON_BUILD_OBJECT(
			'craftsdwarf_ids', (
				SELECT JSON_ARRAYAGG(em.dwarf_id)
				FROM Workshop_Craftsdwarves w_c 
				WHERE w_c.workshop_id = w.workshop_id
			),
			'product_ids', (
				SELECT JSON_ARRAYAGG(w_p.product_id)
				FROM Workshop_Products w_p
				WHERE w_p.workshop_id = w.workshop_id
			),
			'material_ids', (
				SELECT JSON_ARRAYAGG(w_m.material_id)
				FROM Workshop_Materials w_m
				WHERE w_m.workshop_id = w.workshop_id
			),
			'project_ids', (
				SELECT JSON_ARRAYAGG(es2.project_id)
				FROM projects pr
				WHERE pr.workshop_id = w.workshop_id
			)
		) AS related_entities
FROM workshops w
JOIN num_craftsdwarves_table num_craftsdwarves_table
	ON num_craftsdwarves_table.workshop_id = w.workshop_id
JOIN total_quantity_produced_table total_quantity_produced_table
	ON total_quantity_produced_table.workshop_id = w.workshop_id
JOIN total_production_value_table total_production_value_table
	ON total_production_value_table.workshop_id = w.workshop_id
	
	
JOIN total_workshop_materials_table total_workshop_materials_table
	ON total_workshop_materials_table.workshop_id = w.workshop_id	
	
JOIN total_skills_per_workshop_table s_p_w
	ON total_skills_per_workshop_table.workshop_id = w.workshop_id
	
	
JOIN zero_product_day_per_w zero_product_day_per_w
	ON zero_product_day_per_w.workshop_id = w.workshop_id
