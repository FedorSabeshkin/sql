# Четвертое задание

## Задача 2
Нужные строки в связях n:m (многие ко многим) достаю через обращению к таблицам связей, в которой каждая строка соответствует одной связи.

```sql
SELECT JSON_AGG(
	JSON_BUILD_OBJECT(
		'dwarf_id', d.dwarf_id,
		'name', d.name,
		'age', d.age,
		'profession', d.profession,
		'related_entities', JSON_OBJECT(
				'skill_ids', (
					SELECT JSON_ARRAYAGG(dw_sk.skill_id)
					FROM DWARF_SKILLS dw_sk
					WHERE dw_sk.dwarf_id = d.dwarf_id
				),
				'assignment_ids', (
					SELECT JSON_ARRAYAGG(dw_ass.assignment_id)
					FROM DWARF_ASSIGNMENTS dw_ass
					WHERE dw_ass.dwarf_id = d.dwarf_id
				),
				'squad_ids', (
					SELECT JSON_ARRAYAGG(sq_dw.squad_id)
					FROM SQUAD_MEMBERS sq_dw
					WHERE sq_dw.dwarf_id = d.dwarf_id
				),
				'equipment_ids', (
					SELECT JSON_ARRAYAGG(eq_dw.equipment_id)
					FROM DWARF_EQUIPMENT eq_dw
					WHERE eq_dw.dwarf_id = d.dwarf_id 
				)
			) AS related_entities
		) AS json_dwarf
	)
FROM 
    dwarfs d;
```

## Задача 3

```sql
SELECT JSON_AGG(
	JSON_BUILD_OBJECT(
		'workshop_id', w.workshop_id,
		'name', w.name,
		'type', w.type,
		'quality', w.quality,
		'related_entities', JSON_OBJECT(
				'craftsdwarf_ids', (
					SELECT JSON_ARRAYAGG(dw_sk.dwarf_id)
					FROM WORKSHOP_CRAFTSDWARVES dw_w
					WHERE dw_w.workshop_id = w.workshop_id 
				),
				'project_ids', (
					SELECT JSON_ARRAYAGG(dw_pr.project_id )
					FROM PROJECTS w_pr
					WHERE w_pr.workshop_id = w.workshop_id 
				),
				'input_material_ids', (
					SELECT JSON_ARRAYAGG(w_wm.material_id)
					FROM WORKSHOP_MATERIALS w_wm
					WHERE w_wm.workshop_id = w.workshop_id
                AND is_input = true
				),
				'output_product_ids', (
					SELECT JSON_ARRAYAGG(w_wm.material_id)
					FROM WORKSHOP_MATERIALS w_wm
					WHERE w_wm.workshop_id = w.workshop_id
                AND is_input = false
				)
			) AS related_entities
		) AS json_workshop
	)
FROM 
    WORKSHOPS w;
```

## Задача 4

```sql
SELECT JSON_AGG(
	JSON_BUILD_OBJECT(
		'squad_id', s.squad_id,
		'name', s.name,
		'formation_type', s.formation_type,
		'leader_id', s.leader_id,
		'related_entities', JSON_OBJECT(
				'member_ids', (
					SELECT JSON_ARRAYAGG(s_sm.dwarf_id)
					FROM SQUAD_MEMBERS s_sm
					WHERE s_sm.squad_id  = s.squad_id  
				),
				'equipment_ids', (
					SELECT JSON_ARRAYAGG(dw_pr.equipment_id)
					FROM SQUAD_EQUIPMENT s_se
					WHERE s_se.squad_id = s.squad_id 
				),
				'operation_ids', (
					SELECT JSON_ARRAYAGG(s_o.operation_id)
					FROM SQUAD_OPERATIONS s_o
					WHERE s_o.squad_id = s.squad_id
				),
				'training_schedule_ids', (
					SELECT JSON_ARRAYAGG(s_st.schedule_id)
					FROM SQUAD_TRAINING s_st
					WHERE s_st.squad_id = s.squad_id
				),
				'battle_report_ids', (
					SELECT JSON_ARRAYAGG(s_sb.report_id)
					FROM SQUAD_BATTLES s_sb
					WHERE s_sb.squad_id = s.squad_id
				)
			) AS related_entities
		) AS json_workshop
	)
FROM 
    MILITARY_SQUADS s;
```
